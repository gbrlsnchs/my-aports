#!/bin/sh

set -e

target_repo="${1:-main}"
target_arch="${2:-x86_64}" # TODO

indexables="$(find "public/repositories/$target_repo/$target_arch" -name '*.apk' -printf "%f\n")"

# shellcheck disable=SC2086
podman container run \
	--rm \
	--tty \
	--interactive \
	--userns=keep-id \
	--group-add=abuild \
	--workdir="/var/my-aports/$target_repo/$target_arch" \
	--volume="$PWD/public/repositories:/var/my-aports" \
	aports apk index -o APKINDEX.tar.gz $indexables
